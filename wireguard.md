# Wireguard Setup script

## 1、install Wireguard

<details open>
<summary>
Ubuntu & Debian
</summary>

```bash
sudo apt-get install wireguard
```
</details>

## 2、generate server-side keys

After the installation is successful, the Wireguard folder is created in the / etc directory. Next, enter the directory to generate a server-side key.

```bash
sudo su
cd /etc/wireguard/
umask 077
wg genkey | tee server_private_key | wg pubkey > server_public_key
```
After the generation is complete, you can see two files with "Server_Private_Key" and "Server_Public_Key" under the current path.

## 3、create a server profile

Create a wg0.conf file in /etc/wireguard/.

```bash
vim /etc/wireguard/wg0.conf
```

The file content is:

```bash
[Interface]
Address = 172.16.200.1/24
SaveConfig = true
PrivateKey = Server's private key（Server_private_key file generated on the server）
ListenPort = 51820

[Peer]
PublicKey = Client's public key（This is the public key generated by the client.）
AllowedIPs = 172.16.200.2/32
```

The wg0.conf just created is mainly for the configuration file of the virtual network card wg0. Among them,

[Interface]: Server-side configuration start flag

Address: the local IP address of the server

SaveConfig: When true, when there is a client connection, save the state information and automatically save it to the wg0.conf file

PrivateKey: the private key of the server

ListenPort: Port number 51820 for the server to listen on

[Peer]: Client start flag, (multiple clients, there will be multiple configuration connections)

PublicKey: It is the public key of the client. This needs to be generated by the client. After the client is generated, it needs to be filled in

AllowedIPs: The addresses that allow clients to connect

## 4、Allow IP forwarding

In the server, it is necessary to add IP forwarding, otherwise the client cannot access the Internet, modify the /etc/sysctl.conf file.

```bash
vim /etc/sysctl.conf
```

Remove the "#" in front of "net.ipv4.ip_forward=1" in the configuration file.

After the modification is completed, after saving, restart the server, or directly use the following commands to operate.

```bash
sysctl -p
echo 1 > /proc/sys/net/ipv4/ip_forward
```
## 5、Modify firewall rules

To set the content of the iptables list, you need to configure the accepted protocol and port number, and data forwarding also needs its support.

```bash
iptables -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
iptables -A INPUT -p udp -m udp --dport 51820 -m conntrack --ctstate NEW -j ACCEPT
iptables -A INPUT -s 172.16.200.0/24 -p tcp -m tcp --dport 53 -m conntrack --ctstate NEW -j ACCEPT
iptables -A INPUT -s 172.16.200.0/24 -p udp -m udp --dport 53 -m conntrack --ctstate NEW -j ACCEPT
iptables -A FORWARD -i wg0 -o wg0 -m conntrack --ctstate NEW -j ACCEPT
iptables -t nat -A POSTROUTING -s 172.16.200.0/24 -o ens4 -j MASQUERADE
```

What needs to be noted here is that the "ens4" in the last line is the name of the server's local network card, which depends on your own network card name. After the configuration is complete, save it.

```bash
apt-get install iptables-persistent
systemctl enable netfilter-persistent
systemctl start netfilter-persistent
netfilter-persistent save
```

## 6、DNS server configuration

This step can be configured or not configured. The main reason is that the public DNS is used, and the IP address is leaked. Therefore, we set up the DNS ourselves and let us hide behind the VPS to strengthen our security. The following statements must be executed one by one.

```bash
apt-get install unbound unbound-host
curl -o /var/lib/unbound/root.hints https://www.internic.net/domain/named.cache
```

Next, configure unbound.

```bash
vi /etc/unbound/unbound.conf.d/root-auto-trust-anchor-file.conf
```

After annotating the original content, modify the content of the configuration file as follows:

```bash
server:
num-threads: 4

#Allow logs
verbosity: 1

#Root server list
root-hints: "/var/lib/unbound/root.hints"

#DNSSEC root key file
auto-trust-anchor-file: "/var/lib/unbound/root.key"

#Allow querying the DNS of any website
interface: 0.0.0.0 max-udp-size: 3072

#Only allow local machine and 172.16.200.0/24 segment ip access
access-control: 0.0.0.0/0 refuse
access-control: 127.0.0.1 allow
access-control: 172.16.200.0/24 allow

#Do not enter the public dns server list
private-address: 172.16.200.0/24

#Hide information
hide-identity: yes
hide-version: yes

#Mandatory DNSSEC
harden-glue: yes
harden-dnssec-stripped: yes
harden-referral-path: yes

#Add an unwanted reply threshold to clean the cache and avoid when possible a DNS Poisoning.
unwanted-reply-threshold: 10000000

#Verify the address and record DNS poisoning incidents（Have the validator print validation failures to the log.）
val-log-level: 1

#Minimum lifetime of cache entries in seconds.
cache-min-ttl: 1800

#Maximum lifetime of cached entries.
cache-max-ttl: 14400
prefetch: yes
prefetch-key: yes
```

After the configuration is complete, start the service and set it to start automatically after booting.

```bash
chown -R unbound:unbound /var/lib/unbound
systemctl enable unbound
systemctl start unbound
```

## 7、Start the virtual network card

Next, set the configuration file of the network card, and turn on the network card and set it as a service, which will start automatically after booting.

```bash
chown -v root:root /etc/wireguard/wg0.conf
chmod -v 600 /etc/wireguard/wg0.conf
wg-quick up wg0
systemctl enable wg-quick@wg0.service
```

When finished, start the wg0 interface with the attributes specified in the configuration file:

```bash
sudo wg-quick up wg0
```

The output will look something like this:

```bash
[#] ip link add wg0 type wireguard
[#] wg setconf wg0 /dev/fd/63
[#] ip -4 address add 172.16.200.1/24 dev wg0
[#] ip link set mtu 1380 up dev wg0
[#] iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o ens4 -j MASQUERADE
```

To check the interface status and configuration, run:

```bash
sudo wg show wg0
```

```bash
interface: wg0
  public key: +Vpyku+gjVJuXGR/OXXt6cmBKPdc06Qnm3hpRhMBtxs=
  private key: (hidden)
  listening port: 51820
```

You can also use ip a show wg0 to verify the interface status:

```bash
ip a show wg0
```

```bash
4: wg0: <POINTOPOINT,NOARP,UP,LOWER_UP> mtu 1420 qdisc noqueue state UNKNOWN group default qlen 1000
    link/none 
    inet 172.16.200.1/24 scope global wg0
       valid_lft forever preferred_lft forever
```

Possible problems

RTNETLINK answers: Permission denied
Please check if your kernel has disabled IPv6 support:

```bash
sysctl -a | grep disable_ipv6
```

If you see an item with = 1, it means that IPv6 is disabled.
Modify the /etc/sysctl.conf file, and change all the values after disable_ipv6 = 1 to 0.

RTNETLINK answers: Operation not supported

Your system may be missing the necessary Kernel Headers, you can use apt to supplement the installation:

```bash
apt install linux-headers-$(uname -r)
```

## 8、How to configure the client

<details open>
<summary>
Ubuntu & Debian
</summary>

```bash
sudo apt-get install wireguard
```
</details>

Install Wireguard on Debian 10

WireGuard is available from the Debian backports repository. To add the repository to your system, run:

```bash
echo 'deb http://ftp.debian.org/debian buster-backports main' | sudo tee /etc/apt/sources.list.d/buster-backports.list
```

After enabling the repository, update the apt cache and install the WireGuard module and tools:

```bash
sudo apt update
sudo apt install wireguard
```

After the installation is complete, use the same method as the server to generate a key for the client.

## 9、Generate client key

After the installation is successful, the wireguard folder will be created in the /etc directory. Next, enter the directory and generate the client key.

```bash
cd /etc/wireguard/
umask 077
wg genkey | tee client_private_key | wg pubkey > client_public_key
```
After the generation is complete, you can see that there are two files "client_private_key" and "client_public_key" in the current path.

## 10、Create a client profile
Create a wg0.conf file under /etc/wireguard/.

```bash
vim /etc/wireguard/wg0.conf
```

The content of the file is:

```bash
[Interface]
Address = 172.16.200.2/32
SaveConfig = true
PrivateKey = Client's private key
DNS = 172.16.200.1
ListenPort = 51820

[Peer]
PublicKey = Server's public key
Endpoint = The physical IP address of the server:51820
AllowedIPs = 172.16.200.0/24
PersistentKeepalive = 25
```

Next,explain the contents of the configuration file:

[Interface]:The beginning part of the client configuration

Address:Client IP address (that is, the local address)

PrivateKey:client private key (client_private_key file generated by the server)

DNS:server IP address as DNS

ListenPort:Port number 51820 for the server to listen on

[Peer]:server configuration information

PublicKey:The public key of the server (server_public_key file generated by the server)

Endpoint:the IP address and port number of the server

AllowedIPs:0.0.0.0/0 is to allow all IP addresses to communicate. If a single IP address, you can write multiple ones separated by commas. The default is to write the client's IP address

PersistentKeepalive:Used to keep the connection check, it will automatically check the connectivity every 25s. If the IP changes, the endpoint will also be automatically updated through this

In particular, if we modify the server configuration file, we need to turn off the network card before modifying the configuration file. After the modification is completed, turn on the network card. The following two commands are mainly used to turn off or start the network card.

```bash
# Turn off the virtual network card
wg-quick down wg0

# Start the virtual network card
wg-quick up wg0

# View WireGuard running status
wg
```

## 11、start the virtual network card

Next, set the configuration file of the network card, and turn on the network card and set it as a service, which will start automatically after booting.

```bash
chown -v root:root /etc/wireguard/wg0.conf
chmod -v 600 /etc/wireguard/wg0.conf
wg-quick up wg0
systemctl enable wg-quick@wg0.service
```

Additional note, if you still can't connect, you can restart the server.
